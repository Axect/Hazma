{\color{red} Should we have boxes for different functions and constructors specifying type signatures? Should that be left for the actual docs in the code? Seems like it, based on other publications in this journal.}

Instances of the \theory\ class represent dark matter models, and are the main objects used to perform analyses in Hazma. Two \theory\ s, each containing a DM and mediator particle, come built into \hazma\. The Lagrangians defining these theories and the domains of validity are described in the following subsection. \theory\ possesses methods to compute quantities such as DM annihilation cross sections, gamma ray spectra and constraints, and CMB constraints. This section catalogues the definitions of these quantities used by \hazma\ along with minimal examples of how to use the associated methods.

\subsection{Built-in Theories}%
\label{sub:built_in_theories}

% Present Lagrangians for scalar and vector models. Link to github with FR and FC calculations.

Each of the models that ship with \hazma\ contain two BSM particles:
\begin{itemize}
    \item A dark matter particle;
    \item A mediator $M$ that interacts with the DM as well as Standard Model particles.
\end{itemize}
The Lagrangians can be expressed as
\begin{align}
    \L &= \L_\u{SM} + \L_\u{DM} + \L_\u{M} + \L_{\u{Int}(M)},
\end{align}
which consists of the SM Lagrangian, the free Lagrangians for the mediator and DM, and the mediator's interactions with the DM and SM fields. Both the dark matter and the mediator are taken to be uncharged under the Standard Model gauge group. The Lagrangian is defined in terms of the microscopic degrees of freedom of the Standard Model (quarks, leptons and gauge bosons). However, at the energy scale of interest for self-annihilations of nonrelativistic MeV dark matter, quarks and gluons are not the corrent strongly-interacting degrees of freedom. Instead, the microscopic Lagrangian must be matched onto the effective Lagrangian for pions and other mesons using the techniques of chiral perturbation theory (chPT). The models currently implemented in \hazma\ utilize leading-order chPT. 

\begin{figure}
    \centering
    \includegraphics[width=\linewidth]{figures/med_and_dm_mass_phase_diagram.pdf}
    \caption{Values of the DM mass $m_\u{DM}$ and mediator mass $m_M$ for which the leading-order chiral perturbation theory calculations used to implement the models built into \hazma\ can be trusted.}
    \label{fig:chpt_validity}
\end{figure}

As with an effective field theory (EFT), chPT has a limited range of validity. Observables in chPT are computed in terms of an expansion in a small parameter, the meson momentum $p$ divided by the mass scale $\Lambda_\u{ChPT} \sim 4 \pi f_\pi \sim 1\us{GeV}$, where $f_\pi$ is the pion decay constant. As $p^2 \to \Lambda_\u{ChPT}$, higher-order Feynman diagrams in the chPT expansion provide contributions to observables comparable to leading order ones. This suggests that leading-order chPT cannot be trusted for computing dark matter self-annihilation cross sections when $m_\u{DM} \gtrsim 500\us{GeV}$. In fact, the convergence of the chPT expansion is disrupted at a lower mass scale by the lowest-lying hadronic resonances, the $\rho$ ($m_\rho = 770\us{GeV}$) and the $f_0(500)$ ($m_{f_0(500)} \sim 450\us{MeV}$). Figure~\ref{fig:chpt_validity} illustrates the resulting regions where the leading-order chPT calculations can and cannot be trusted in the $(m_\u{DM}, m_\u{mediator})$ plane. An important consequence is that annihilation into kaons and heavier mesons can be ignored since that would require DM masses far above the chPT range of validity. This is important to keep in mind when using the models provided with \hazma\.\footnote{Of course, user-defined models (see Section~\ref{sec:advanced_usage}) need not use leading-order chPT.}

While the preceding discussion applies irrespective of the mediator and DM spin and quantum numbers, the rest of this subsection specializes to the two models that come with \hazma\: \sm, which contains a real scalar mediator $S$ and \vm, where the mediator is a vector $V$.
 In both cases the DM is taken to be a Dirac fermion, so that
\begin{align}
    \L &= \bar{\chi} (i \slashed \d - m_\chi) \chi.
\end{align}
The rest of this subsection presents $\L_{\u{Int}(S)}$ and $\L_{\u{Int}(V)}$ at the level of quarks and gluons as well as the Lagrangians obtained by performing the chPT matching. Snippets are provided to demonstrate how to construct each \theory\ and change its parameters. The interaction Lagrangians, matching procedure and a brief overview of the chiral Lagrangian are explained in detail in a companion paper~\cite{matching_paper}.

\subsubsection{\sm}

The free Lagrangian for a real scalar is
\begin{align}
    \L_S &= \frac{1}{2} (\d_\mu S) (\d^\mu S) - \frac{1}{2} m_S^2 S^2,
\end{align}
where $m_S$ is the scalar's mass. The interactions with the light fundamental SM degrees of freedom
\begin{align}
    \L_{\u{Int}(S)} &= -S \left( g_{S\chi} + g_{Sf} \sum_f \frac{y_f}{\sqrt{2}} \bar{f} f \right)\\
                    &\hspace{2cm} + \frac{S}{\Lambda} \left( g_{SF} \frac{\alpha_\u{EM}}{4\pi} F_{\mu\nu} F^{\mu\nu} + g_{SG} \frac{\alpha_s}{4\pi} G_{\mu\nu}^a G^{a \mu\nu} \right).
\end{align}
The sum runs over fermions with mass below the GeV scale ($f = e, \mu, u, d, s$). Note that the coupling $g_{Sf}$ is outside the sum. The Yukawas are defined to be $y_f = \sqrt{2} m_f / v_h$, with the Higgs vacuum expectation value (vev) defined as $v_h = 246\us{GeV}$. The parameter $\Lambda$ is the mass scale at which $S$ acquires (non-renormalizable) interactions with the photon and gluon.

After performing the matching onto the chiral Lagrangian and expanding to leading order in the pion fields, the resulting interaction Lagrangian is
\begin{align}
    \L_{\mathrm{Int}(S)} &= \frac{2 g_{SG}}{9 \Lambda} S \left[ (\d_\mu \pi^0) (\d^\mu \pi^0) + 2 (\d_\mu \pi^+) (\d^\mu \pi^-) \right]\\
                         &\hspace{1cm} + \frac{4 i e g_{SG}}{9 \Lambda} S A^\mu \left[ \pi^- (\d_\mu \pi^+) - \pi^+ (\d_\mu \pi^-) \right]\\
                         &\hspace{1cm} - \frac{B (m_u + m_d)}{6} \left( \frac{3 g_{Sf}}{v_h} + \frac{2 g_{SG}}{3 \Lambda} \right) S \left[ (\pi^0)^2 + 2 \pi^+ \pi^- \right]\\
                         &\hspace{1cm} + \frac{B (m_u + m_d) g_{SG}}{81 \Lambda} \left( \frac{2 g_{SG}}{\Lambda} - \frac{9 g_{Sf}}{v_h} \right) S^2 \left[ (\pi^0)^2 + 2 \pi^+ \pi^- \right]\\
                         &\hspace{1cm} + \frac{4 e^2 g_{SG}}{9\Lambda} S \pi^+ \pi^- A_\mu A^\mu\\
                         &\hspace{1cm} - g_{S \chi} S \bar{\chi} \chi - g_{Sf} S \sum_{\ell=e,\mu} \frac{y_\ell}{\sqrt{2}} \bar{\ell} \ell + \frac{\alpha_s}{4\pi \Lambda} g_{SG} S G_{\mu\nu}^a G^{a \mu\nu}.
\end{align}

The parameters for the scalar model are attributes of the \sm\ class. Their names in \hazma\ are
\begin{align*}
    (m_\chi, m_S, g_{S\chi}, g_{Sf}, g_{SG}, g_{SF}, \Lambda) \leftrightarrow (\mathtt{mx}, \mathtt{ms}, \mathtt{gsxx}, \mathtt{gsff}, \mathtt{gsGG}, \mathtt{gsFF}, \mathtt{lam}).
\end{align*}
The following snippet shows how to create an instance of \sm, change the value of a parameter, and print its new value:
\begin{minted}[bgcolor=bg]{python}
>>> from hazma.scalar_mediator import ScalarMediator
>>> sm = ScalarMediator(mx=150., ms=1e3, gsxx=1., gsff=0.1,
...                     gsGG=0.1, gsFF=0.1, lam=2e5)
>>> print(sm.gsff)
0.1
>>> sm.gsff = 0.5
>>> print(sm.gsff)
0.5
\end{minted}

{\color{red} Talk about Higgs portal and heavy fermion subclasses!}

\subsubsection{\vm}

For the vector mediator the free part of the Lagrangian is
\begin{align}
    \L_V &= -\frac{1}{4} V_{\mu\nu} V^{\mu\nu} + \frac{1}{2} m_V^2 V_\mu V^\mu,
\end{align}
where $m_V$ is the mass of the vector. The interactions considered are
\begin{align}
    \L_{\u{Int}(V)} &= V_\mu \left( g_{V\chi} \bar{\chi} \gamma^\mu \chi + \sum_f g_{Vf} \bar{f} \gamma^\mu f \right) - \frac{\epsilon}{2} V^{\mu\nu} F_{\mu\nu}.
\end{align}
The sum again runs over the light fermions ($f = e, \mu, u, d, s$), and $V$ may have different couplings to each of these. The last term is a kinetic mixing between the photon and $V$, which can be eliminated by transforming the photon $A_\mu \to A_\mu - \epsilon V_\mu$. Upon this field redefinition $V$ acquires an $\epsilon$-suppressed interaction with the SM fermions, which is captured by changing the fermion couplings
\begin{align}
    g_{Vf} \to g_{Vf} - \epsilon e Q_f,
\end{align}
where $Q_f$ is the electric charge of the fermion $f$ and $e > 0$ is the electron's charge.

Matching onto the chiral Lagrangian and isolating the terms contributing at leading order to the quantities computed in \hazma\ gives
\begin{align}
    \L_{\mathrm{Int}(V)} &= -i (g_{Vu} - g_{Vd}) V^\mu \left( \pi^+ \d_\mu \pi^- - \pi^- \d_\mu \pi^+ \right)\\
                         &\hspace{1cm} + ( g_{Vu} - g_{Vd} )^2 V_\mu V^\mu \pi^+ \pi^-\\
                         &\hspace{1cm} + 2 e (Q_u - Q_d) (g_{Vu} - g_{Vd}) A_\mu V^\mu \pi^+ \pi^-\\
                         &\hspace{1cm} + \frac{1}{8\pi^2 f_\pi} \epsilon^{\mu\nu\rho\sigma} (\d_\mu \pi^0)\\
                         &\hspace{2cm} \times \left\{ e (2 g_{Vu} + g_{Vd}) \left[ (\d_\nu A_\rho) V_\sigma + (\d_\nu V_\rho) A_\sigma \right] \right.\\
                         &\hspace{4cm} \left. + 3 (g_{Vu}^2 - g_{Vd}^2) (\d_\nu V_\rho) V_\sigma \right\}.
\end{align} 

The base \vm\ class contains the parameters\footnote{Note that $\texttt{gvss}$ is not currently used since \vm\ is based on leading-order chPT.}
\begin{align*}
    &(m_\chi, m_V, g_{V\chi}, g_{Vu}, g_{Vd}, g_{Vs}, g_{Ve}, g_{V\mu})\\
    &\hspace{1cm} \leftrightarrow (\texttt{mx}, \texttt{mv}, \texttt{gvxx}, \texttt{gvuu}, \texttt{gvdd}, \texttt{gvss}, \texttt{gvee}, \texttt{gvmumu}).
\end{align*}
The following snippet shows how to instantiate and alter the parameter values for \vm:
\begin{minted}[bgcolor=bg]{python}
>>> from hazma.vector_mediator import VectorMediator
>>> vm = VectorMediator(mx=150., mv=1e3, gvxx=1., gvuu=0.1,
...                     gvdd=0.2, gvss=0.3, gvee=0.4,
...                     gvmumu=0.5)
>>> print(vm.gvee)
0.4
>>> print(vm.gvuu)
0.1
>>> vm.gvuu = 0.05
>>> print(vm.gvuu)
0.05
\end{minted}

For convenience, a subclass called \texttt{KineticMixing} is also provided to handle the important case where $V$ couples to the SM purely through the kinetic mixing term ($\epsilon \neq 0$, $g_{Vf} = 0$ for all $f$). The parameters for this subclass are
\begin{align*}
    (m_\chi, m_V, g_{V\chi}, \epsilon) \leftrightarrow (\texttt{mx}, \texttt{mv}, \texttt{gvxx}, \texttt{eps}).
\end{align*}
While the underlying parameters \texttt{gvuu}, \dots, \texttt{gvmumu} can be accessed by instances of \texttt{KineticMixing}, they cannot be set directly since they are fully determined by \texttt{eps}:
\begin{minted}[bgcolor=bg]{python}
>>> from hazma.vector_mediator import KineticMixing
>>> km = KineticMixing(mx=150., mv=1e3, gvxx=1., eps=0.1)
>>> km.eps
0.1
>>> km.gvuu
-0.020187846690459792  # = -0.1 * 2/3 * sqrt(4 pi / 137)
>>> km.gvuu = 0.1
AttributeError: Cannot set gvuu
\end{minted}

\subsection{Cross section, decay widths and branching fractions}

\paragraph{\texttt{theory.list\_annihilation\_final\_states()}} Lists the final states into which the DM can potentially annihilate. These are based on the terms appearing in $\L_{\u{Int}(M)}$. Note that the actual branching fractions into a given final state may be zero if the relevant couplings are zero or the center of mass energy for the annihilation is smaller than the sum of the final state particles' masses. 
\begin{minted}[bgcolor=bg]{python}
>>> ScalarMediator.list_annihilation_final_states()
['mu mu', 'e e', 'g g', 'pi0 pi0', 'pi pi', 's s']
>>> VectorMediator.list_annihilation_final_states()
['mu mu', 'e e', 'pi pi', 'pi0 g', 'v v']
\end{minted}
{\color{red} This is not quite right. For example, it excludes the final states $e^+ e^- \gamma$, $S \pi^0 \pi^0$, $\pi^+ \pi^- \gamma \gamma$ for the scalar and $V \pi^0$ for the vector. While that's fine since those final states are so suppressed, the wording here needs to be precise.}

\paragraph{\texttt{theory.annihilation\_cross\_sections(cme)}} For an instance \mil{th} of theory and a center of mass energy \texttt{cme}, this returns a \mil{dict} whose keys are the elements of \mil{th.list_annihilation_final_states()} and \mil{'total'} and whose values are the corresponding cross sections for annihilating into those states. In the following example, the DM is lighter than the mediator, but the center of mass energy is large enough to permit annihilations into the mediator:
\begin{minted}[bgcolor=bg]{python}
>>> sm = ScalarMediator(mx=180., ms=190., gsxx=1., gsff=0.1,
...                     gsGG=0.1, gsFF=0.1, lam=2e5)
>>> xsecs = sm.annihilation_cross_sections(400.)
>>> print(xsecs)
{'g g': 5.668702951121324e-32,
 'e e': 4.525214520210817e-32,
 'pi0 pi0': 1.8542010286144253e-27,
 'total': 4.1600065791804136e-18,
 's s': 4.160006572615015e-18,
 'mu mu': 1.1842156064646993e-27,
 'pi pi': 3.526880321768581e-27}
\end{minted}

\paragraph{\texttt{theory.annihilation\_branching\_fractions(cme)}} For an instance \mil{th} of theory and a center of mass energy \texttt{cme}, this returns a \mil{dict} whose keys are the elements of \mil{th.list_annihilation_final_states()} and whose values are the corresponding branching fractions for annihilating into those states.
\begin{minted}[bgcolor=bg]{python}
>>> km = KineticMixing(mx=170., mv=1e3, gvxx=1., eps=0.2)
>>> bfs = km.annihilation_branching_fractions(400.)
>>> print(bfs)
{'pi0 g': 1.5585058782195258e-05,
 'e e': 0.4855695299567697,
 'mu mu': 0.4698109970123726,
 'v v': 0.0,
 'pi pi': 0.04460388797207543}
\end{minted}


\paragraph{\texttt{theory.partial\_widths()}}

\subsection{Gamma ray and positron spectra}

\subsection{Gamma ray limits}

Explain procedure

\subsection{Cosmic Microwave Background limits}

Explain procedure

